<?xml version="1.0" encoding="UTF-8" ?>
<Module>
	<ModulePrefs title="Basket Manager" author="gfbiodev"
			author_email="dev@gfbio.org" >
		<Require feature="pubsub-2">
			<Param name="topics">
				<![CDATA[
        <Topic title="GFBio Basket Manager" name="gfbio.basket.selectedData" publish="true" subscribe="true"/>
          ]]>
			</Param>
		</Require>
		<Require feature="dynamic-height" />
	</ModulePrefs>
	<Content type="html">
			<![CDATA[
	<!DOCTYPE html>
		<html style="min-height: 350px;">
			<head  lang="en">
				<meta charset="UTF-8">
				<title>GFBio Basket Manager</title>
				<script src="http://gfbio-dev1.inf-bb.uni-jena.de/gfbio/search/js/jquery-1.10.2.js"	type="text/javascript"></script>
				<script src="http://gfbio-dev1.inf-bb.uni-jena.de/gfbio/search/js/jquery-1.10.2-ui.js"	type="text/javascript"></script>
				<link rel="stylesheet"	href="http://gfbio-dev1.inf-bb.uni-jena.de/gfbio/search/css/jquery-ui.css" />
				<link rel="stylesheet"	href="http://gfbio-dev1.inf-bb.uni-jena.de/gfbio/search/css/basketmanager.css" />
				<script>
					$(function() {
						getUserList();
						adjust();
					});
					function getUserList(){
					
						var currentUID = parent.Liferay.ThemeDisplay.getUserId();
						var currentUName =	parent.Liferay.ThemeDisplay.getUserName();	
						parent.Liferay.Service(
						  '/GFBioProject-portlet.basket/get-basket-users-ids',
						  {
							userId: currentUID
						  },
						  function(obj) {
							var i = 0;
							var userSelect = document.getElementById('userSelect');
							for(var key in obj){
								var option = document.createElement("option");
								option.value = key;
								option.text = obj[key];
								userSelect.add(option);
								if (key == currentUID) {
									console.log(key);
									userSelect.value = key;
									getBaskets();
								}
								i++;
							}
							if (i==0){
								// the current user has no right to see other users
								var option = document.createElement("option");
								option.value = currentUID;
								option.text = currentUName;
								option.select = "selected";
								userSelect.add(option);
								userSelect.disabled = true;
								getBaskets();
							}else{
								userSelect.disabled = false;
							}
						  }
						);
					}
					
					function getBaskets(){
						var uId = document.getElementById('userSelect').value;
						var period = document.getElementById('periodSelect').value;
						parent.Liferay.Service(
						'/GFBioProject-portlet.basket/get-baskets-by-user-and-period',
						  {
							userId: uId,
							period: period
						  },
						  function(obj) {
							var basketsHTML = "";
							for(var key in obj){
								//console.log(obj[key]);
								var basket = obj[key];
								basketsHTML += writeBasketsHTML(basket);
							}
							var isAccordion = $("#baskets").hasClass("ui-accordion");
							if (isAccordion) $( "#baskets" ).accordion("destroy");
							document.getElementById('baskets').innerHTML = basketsHTML;
							$( "#baskets" ).accordion({
							    collapsible: true,
								activate: function(event, ui) {
									adjust();
								},
								create( event, ui ){
									adjust();
								}
							});
						  }
						);
						adjust();
					}
					
					function writeBasketsHTML(basket){
						var basketsHTML = "<h3>"+basket.name+" : "+basket.basketID+"</h3>";
						basketsHTML += "<div>";
						
						basketsHTML += "ID: "+basket.basketID;
						basketsHTML += "<br/>";
						
						basketsHTML += "JSON: "+basket.basketJSON;
						basketsHTML += "<br/>";
						
						basketsHTML += "Last Modified: "+basket.lastModifiedDate;
						basketsHTML += "<br/>";
						
						basketsHTML += "Query: "+basket.queryJSON;
						basketsHTML += "<br/>";
						
						//basketsHTML += "User ID: "+basket.userID;
						//basketsHTML += "<br/>";
						
						basketsHTML += "</div>";
						return basketsHTML;
					}
					
					function adjust() {
					   //console.log('auto adjust height');
					   var height = $('#input').height()+$('#baskets').height()+50;
					   if (height < 350){ 
							height = 350;
					   }
						gadgets.window.adjustHeight(height);
					}
				</script>
			</head>
			<body style="margin: 0px;"> 
				<div id="input">
					<p>
					<label for="userSelect">User:
					<select name="userSelect" id="userSelect" onchange="getBaskets();">
					</select></label>
					</p>
					<p>
					<label for="periodSelect">Baskets created since
					<select name="periodSelect" id="periodSelect" onchange="getBaskets();">
						<option value="0" selected="selected">All</option>
						<option value="1">1 day</option>
						<option value="2">2 days</option>
						<option value="10">1 week</option>
						<option value="20">2 weeks</option>
						<option value="100">1 month</option>
						<option value="200">2 months</option>
						<option value="300">3 months</option>
						<option value="600">6 months</option>
						<option value="1000">1 year</option>
						<option value="2000">2 years</option>
						<option value="3000">3 years</option>
					</select></label>
					</p>
				</div>
				 <div id="baskets">
				</div>
			</body>
		</html>
	]]>
		</Content>
</Module>