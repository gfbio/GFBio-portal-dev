<?xml version="1.0" encoding="UTF-8"?>
<custom-sql>

    <sql id="org.gfbio.service.persistence.SubmissionRegistryFinderImpl.getArchivePIdsOfENA">
	    <![CDATA[
			SELECT 
				archive_pid
			FROM 
				public.gfbio_submissionregistry
			WHERE
				researchobjectid in (
					SELECT 
						researchobjectid
					FROM
						public.gfbio_researchobject
					WHERE 
						parentresearchobjectid =(
							SELECT
							 	parentresearchobjectid
							FROM
								public.gfbio_researchobject
							WHERE 
							  	researchobjectid =(
									SELECT 
									  researchobjectid 
									FROM 
									  public.gfbio_submissionregistry
									WHERE 
									  archive_pid=?)))

		]]>
    </sql>
    
   <sql id="org.gfbio.service.persistence.SubmissionRegistryFinderImpl.getArchivePIdsWithTypeOfENA">
	    <![CDATA[
			SELECT 
				archive_pid
			FROM 
			  	public.gfbio_submissionregistry
			WHERE
				researchobjectid in (
					SELECT 
						researchobjectid
					FROM
						public.gfbio_researchobject
					WHERE 
						public.gfbio_researchobject.researchobjecttype = ? AND
						parentresearchobjectid =(
							SELECT
								parentresearchobjectid
							FROM
								public.gfbio_researchobject
							WHERE
								researchobjectid =(
									SELECT 
										researchobjectid 
									FROM 
										public.gfbio_submissionregistry
									WHERE 
										archive_pid=?)))


		]]>
    </sql>

    <sql id="org.gfbio.service.persistence.SubmissionRegistryFinderImpl.getLatestSubmissionByIds">
	    <![CDATA[
		    SELECT
				* 
			FROM
				(
			    	SELECT
			    		*,
			       		rank() OVER (PARTITION BY researchobjectid, archive ORDER BY researchobjectversion DESC) AS pos
			       FROM
			       		gfbio_submissionregistry
			       	where
						gfbio_submissionregistry.researchobjectid = ? AND
						gfbio_submissionregistry.archive = ?
			    ) AS iq
			WHERE pos=1
		]]>
    </sql>
    
    <sql id="org.gfbio.service.persistence.SubmissionRegistryFinderImpl.getLatestSubmissions">
	    <![CDATA[
		    SELECT
				* 
			FROM
				(
			    	SELECT
			    		*,
			       		rank() OVER (PARTITION BY researchobjectid, archive ORDER BY researchobjectversion DESC) AS pos
			       FROM
			       		gfbio_submissionregistry
			    ) AS iq
			WHERE pos=1
		]]>
    </sql>
    
    <sql id="org.gfbio.service.persistence.SubmissionRegistryFinderImpl.getLatestSubmissionsByArchive">
	    <![CDATA[
		    SELECT
				* 
			FROM
				(
			    	SELECT
			    		*,
			       		rank() OVER (PARTITION BY researchobjectid, archive ORDER BY researchobjectversion DESC) AS pos
			       FROM
			       		gfbio_submissionregistry
			       	where
						gfbio_submissionregistry.archive = ?
			    ) AS iq
			WHERE pos=1
		]]>
    </sql>
    
    <sql id="org.gfbio.service.persistence.SubmissionRegistryFinderImpl.getLatestSubmissionsByResearchObjectId">
	    <![CDATA[
		    SELECT
				* 
			FROM
				(
			    	SELECT
			    		*,
			       		rank() OVER (PARTITION BY researchobjectid, archive ORDER BY researchobjectversion DESC) AS pos
			       FROM
			       		gfbio_submissionregistry
			       	where
						gfbio_submissionregistry.researchobjectid = ?
			    ) AS iq
			WHERE pos=1
		]]>
    </sql>
    
   <sql id="org.gfbio.service.persistence.SubmissionRegistryFinderImpl.getResearchObjectVersion">
	    <![CDATA[
			SELECT 
			  public.gfbio_submissionregistry.researchobjectversion 
			FROM 
			  public.gfbio_submissionregistry 
			WHERE 
			  gfbio_submissionregistry.researchobjectid = ? AND
			  gfbio_submissionregistry.archive = ? AND
			  gfbio_submissionregistry.brokersubmissionid = ?
		]]>
    </sql>
    
    <sql id="org.gfbio.service.persistence.SubmissionRegistryFinderImpl.getStatusByIds">
	    <![CDATA[
		    SELECT 
				gfbio_submissionregistry.status
			FROM 
				public.gfbio_submissionregistry
			where	
				gfbio_submissionregistry.researchobjectid = ? AND
				gfbio_submissionregistry.researchobjectversion =	? AND
				gfbio_submissionregistry.archive = ?
		]]>
    </sql>
    
    

    
   
</custom-sql>